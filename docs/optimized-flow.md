# Оптимизированный флоу обработки сообщений

## Проблема
Предыдущая архитектура отправляла все сообщения через бэкенд, что приводило к:
- Медленной обработке сообщений без файлов
- Ненужной нагрузке на бэкенд
- Длительным ожиданиям пользователей

## Новая архитектура

### Флоу для сообщений БЕЗ файлов (оптимизированный)
```
Пользователь → Фронтенд → VITE_API_URL (напрямую) → Ответ → Фронтенд
```

### Флоу для сообщений С файлами
```
Пользователь → Фронтенд → Бэкенд → Обработка файла → AI API → Ответ → Фронтенд
```

## Логика принятия решений

### 1. Нет файлов
- **Действие**: Прямой вызов `sendDirectMessageAction()`
- **Путь**: `VITE_API_URL/agent/run`
- **Преимущества**: Максимальная скорость, минимальная задержка

### 2. Есть файлы данных (.csv, .xlsx, .json, .txt)
- **Действие**: Обработка через бэкенд `backendService.processFile()`
- **Путь**: `localhost:8000/process-file` → AI API
- **Преимущества**: Полная обработка данных с pandas

### 3. Есть только изображения
- **Действие**: Стандартный `sendMessageAction()`
- **Путь**: `VITE_API_URL/agent/run` с attachments
- **Преимущества**: Прямая отправка изображений в AI API

## Реализация

### Новые функции

#### `sendDirectMessage()` в `agent-api.ts`
```typescript
export async function sendDirectMessage(message: string): Promise<SendToAgentOutput> {
  const baseUrl = process.env.VITE_API_URL;
  const apiUrl = `${baseUrl}/agent/run`;
  
  const requestData = {
    message,
    execution_mode: 'sync',
    with_tts: false,
  };
  
  // Прямой вызов без обработки файлов
}
```

#### `sendDirectMessageAction()` в `actions.ts`
```typescript
export async function sendDirectMessageAction(prompt: string) {
  try {
    const result = await sendDirectMessage(prompt);
    return { response: result.response };
  } catch (e) {
    // Обработка ошибок
  }
}
```

### Обновленная логика в `chat-ui.tsx`
```typescript
if (filesToProcess.length === 0) {
  // Нет файлов - прямой вызов AI API
  result = await sendDirectMessageAction(prompt);
} else {
  // Есть файлы - определяем тип обработки
  const dataFiles = filesToProcess.filter(/* фильтр данных */);
  
  if (dataFiles.length > 0) {
    // Файлы данных - через бэкенд
    result = await backendService.processFile(...);
  } else {
    // Только изображения - стандартный флоу
    result = await sendMessageAction(formData);
  }
}
```

## Преимущества новой архитектуры

### 1. Производительность
- **Сообщения без файлов**: Мгновенная отправка без задержек бэкенда
- **Меньше нагрузки**: Бэкенд используется только когда необходимо
- **Параллельная обработка**: Разные типы запросов не блокируют друг друга

### 2. Надежность
- **Fallback механизм**: При ошибке бэкенда используется стандартный флоу
- **Изоляция ошибок**: Проблемы с файлами не влияют на текстовые сообщения
- **Простота отладки**: Четкое разделение путей обработки

### 3. Масштабируемость
- **Независимые компоненты**: Фронтенд и бэкенд могут масштабироваться отдельно
- **Оптимизация ресурсов**: Бэкенд работает только с файлами
- **Кэширование**: Возможность кэширования на разных уровнях

## Конфигурация

### Переменные окружения
```bash
# Прямой AI API для сообщений без файлов
VITE_API_URL=https://ai-platform-connect.kassen.space/connect/v1/...

# Бэкенд для обработки файлов
BACKEND_URL=http://localhost:8000
```

### Настройки бэкенда
```python
# backend/config.py
DEFAULT_AI_API_URL = "https://ai-platform-connect.kassen.space/connect/v1/..."
AI_API_TIMEOUT = 180  # 3 минуты для файлов
```

## Мониторинг и отладка

### Логи для отслеживания
- Прямые вызовы: `sendDirectMessage` в консоли браузера
- Обработка файлов: `Backend processing` в консоли
- Ошибки: Детальные сообщения для каждого типа флоу

### Метрики производительности
- Время ответа для текстовых сообщений: < 2 секунд
- Время обработки файлов: зависит от размера
- Процент успешных запросов по типам

## Тестирование

### Сценарии тестирования
1. **Текстовое сообщение**: Должно идти напрямую в VITE_API_URL
2. **Сообщение с CSV**: Должно обрабатываться через бэкенд
3. **Сообщение с изображением**: Должно идти через стандартный флоу
4. **Смешанные файлы**: Приоритет файлам данных
5. **Ошибка бэкенда**: Fallback на стандартный флоу

### Проверка производительности
```bash
# Время ответа без файлов
curl -X POST "$VITE_API_URL/agent/run" \
  -H "Content-Type: application/json" \
  -d '{"message":"Привет","execution_mode":"sync"}'

# Время обработки файла
curl -X POST "http://localhost:8000/process-file" \
  -F "file=@test.csv" \
  -F "prompt=Анализируй данные"
```

## Будущие улучшения

1. **Кэширование ответов** для часто задаваемых вопросов
2. **Предварительная загрузка** для больших файлов
3. **WebSocket соединения** для real-time обновлений
4. **Сжатие данных** для оптимизации трафика
5. **CDN интеграция** для статических ресурсов

## Заключение

Новая архитектура обеспечивает:
- **Быстрые ответы** для простых сообщений
- **Эффективную обработку** файлов данных
- **Надежность** через fallback механизмы
- **Масштабируемость** для будущего роста

Пользователи теперь получают мгновенные ответы на текстовые вопросы, а файлы обрабатываются только когда это действительно необходимо.