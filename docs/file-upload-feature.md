# Функция загрузки файлов

## Обзор

Добавлена комплексная система загрузки файлов, которая позволяет пользователям прикреплять любые типы файлов к сообщениям в чате. Все файлы отправляются как `attachment` параметр к API через `VITE_API_URL`.

## Реализованные функции

### 1. Поддержка множественных файлов
- Пользователи могут выбирать и прикреплять несколько файлов одновременно
- Поддерживаются все типы файлов (изображения, документы, видео, аудио, архивы и т.д.)
- Интуитивный интерфейс с предпросмотром файлов

### 2. API интеграция
- Файлы автоматически конвертируются в base64 и отправляются как attachments
- Совместимость с существующей системой обработки изображений
- Структура API поддерживает метаданные файлов (имя, размер, тип)

### 3. UI компоненты

#### FileAttachmentComponent
- Отображает индивидуальные файловые вложения
- Поддерживает предпросмотр изображений
- Показывает иконки для разных типов файлов
- Отображает размер файла в человекочитаемом формате

#### FileAttachmentList
- Компонент для отображения списка файлов
- Поддерживает ограничение количества отображаемых файлов
- Показывает счетчик оставшихся файлов

#### Обновленный ChatInput
- Поддержка множественной загрузки файлов
- Кнопка "Очистить все" для удаления всех вложений
- Предпросмотр всех прикрепленных файлов

## Структура данных

### FileAttachment
```typescript
interface FileAttachment {
  id: string;
  name: string;
  type: string;
  size: number;
  url: string;
  isImage?: boolean;
}
```

### Message (обновленный)
```typescript
interface Message {
  id: string;
  role: 'user' | 'ai';
  content: string;
  image?: string; // Deprecated: используйте attachments
  attachments?: FileAttachment[];
  timestamp: Date;
  visualization?: { ... };
}
```

## API структура

Файлы отправляются к `VITE_API_URL/agent/run` в следующем формате:

```typescript
{
  message: string;
  attachments?: Array<{
    type: 'image' | 'video' | 'file' | 'audio';
    url: string; // base64 data URI
    filename: string;
    content_type: string;
    size: number;
    metadata?: Record<string, any>;
    alt_text?: string;
    width?: number;
    height?: number;
    duration?: number;
    transcript?: string;
  }>;
  customer_id?: string;
  session_id?: string;
  execution_mode: 'sync' | 'async';
  metadata?: Record<string, any>;
  with_tts: boolean;
}
```

## Конфигурация

Убедитесь, что переменная окружения `VITE_API_URL` настроена:

```env
VITE_API_URL=https://your-api-domain.com/api/v1
```

## Обратная совместимость

- Старое поле `image` в сообщениях поддерживается для обратной совместимости
- Существующие компоненты работают без изменений
- API функция `createSimpleAgentInput` по-прежнему доступна

## Использование

1. **Загрузка файлов**: Нажмите кнопку скрепки в поле ввода
2. **Выбор файлов**: Выберите один или несколько файлов любого типа
3. **Предпросмотр**: Просмотрите прикрепленные файлы перед отправкой
4. **Отправка**: Файлы автоматически включаются в сообщение к API

## Ограничения и рекомендации

- Размеры файлов ограничены возможностями браузера и API
- Большие файлы конвертируются в base64, что увеличивает размер данных
- Рекомендуется устанавливать лимиты на размер файлов на стороне сервера

## Файлы, которые были изменены

1. `src/lib/types.ts` - Добавлены типы для файловых вложений
2. `src/app/actions.ts` - Обновлена логика обработки файлов
3. `src/ai/flows/agent-api.ts` - Добавлена функция `createMultiFileAgentInput`
4. `src/components/file-attachment.tsx` - Новый компонент для отображения файлов
5. `src/components/chat-input.tsx` - Обновлен для поддержки множественных файлов
6. `src/components/chat-ui.tsx` - Обновлена обработка файловых вложений
7. `src/components/chat-message.tsx` - Добавлено отображение файлов в сообщениях

